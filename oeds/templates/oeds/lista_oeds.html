{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gerenciar {{ verbose_name_plural }}</h2>
        <a href="{{ view.get_create_url }}" class="btn btn-success">
            <i class="fas fa-plus"></i> Novo OED
        </a>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form method="get" class="row g-3">

                <div class="col-12 mt-1">
                    <label class="form-label fw-bold text-primary">Busca rápida</label>
                    <div class="input-group">
                        <span class="input-group-text bg-primary text-white"><i class="fas fa-search"></i></span>
                        <input type="text" name="q" class="form-control form-control-lg" placeholder="Pesquise em todos os campos..."
                            value="{{ request.GET.q }}">
                    </div>
                </div>
                <div class="col-12 mt-0">
                    <p class="text-muted mb-0" style="font-size: 0.75rem; letter-spacing: -0.2px;">Exceto: status, tipo, projeto, componente, volume, capítulo, página, quantidade de pontos, coordenadas, criado por (ver filtros avançados)</p>
                </div>
                <div class="col-12 mt-0">
                    <div class="accordion mt-1" id="accordionFiltros">
                        <div class="accordion-item border-0">
                            <h2 class="accordion-header" id="headingFiltros">
                                <button class="accordion-button collapsed p-2 bg-light text-muted small" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapseFiltros" aria-expanded="false"
                                    aria-controls="collapseFiltros">
                                    <i class="fas fa-filter me-2"></i> Filtros avançados
                                </button>
                            </h2>
                            <div id="collapseFiltros"
                                class="accordion-collapse collapse {% if not request.GET.q and request.GET %}show{% endif %}"
                                aria-labelledby="headingFiltros" data-bs-parent="#accordionFiltros">
                                <div class="accordion-body px-0 py-3">
                                    <div class="row g-3">
                                        {% for field in filter.form %}
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold">{{ field.label }}</label>
                                            {{ field }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 d-flex justify-content-end gap-2 border-top pt-3 mt-1">
                    <a href="{% url 'listar_oeds' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-eraser me-1"></i> Limpar
                    </a>
                    <button type="submit" class="btn btn-primary btn-sm px-4">
                        <i class="fas fa-filter me-1"></i> Aplicar filtros
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle bg-white">
            <thead class="table-dark">
                <tr>
                    <th>OEDs</th>
                    <th class="text-center" style="width:70px;">Preview</th>
                    <th>Tipo</th>
                    <th title="Projeto / Componente / Volume">Proj./Comp./Vol.</th>
                    <th>Status</th>
                    <th>Criado por / Atribuído a</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for oed in object_list %}
                <tr>
                    <td title="Título e retranca">
                        <strong>{{ oed.titulo|striptags }}</strong><br>
                        <small class="text-muted">{{ oed.retranca }}</small>
                    </td>
                    <td class="text-center" title="Visualizar OED">
                        <a href="{% url 'oeds_preview:oed_preview' pk=oed.pk %}" target="_blank"
                            class="btn btn-outline-secondary">

                            {% if oed.imagem_principal %}
                            <img src="{{ oed.imagem_principal.url }}" alt="Preview"
                                style="width:50px; height:50px; object-fit:cover; border-radius:6px;">
                            {% else %}
                            <div style="width:50px; height:50px; background:#f1f1f1; border-radius:6px;"></div>
                            {% endif %}

                        </a>
                    </td>

                    <td title="Tipo do OED">{{ oed.tipo|striptags }}</td>
                    <td title="Projeto / Componente / Volume">
                        <span class="badge bg-primary">{{ oed.projeto|default:"-" }}</span>
                        <span class="badge bg-secondary">{{ oed.componente|default:"-" }}</span>
                        <span class="badge bg-secondary">{{ oed.volume|default:"-" }}</span>
                    </td>
                    <td title="Status">{{ oed.status }}</td>
                    <td title="Criado por ou atribuído a">
                        <small><strong>Criado por:</strong> {{ oed.criado_por }}</small> <br>
                        <small><strong>Atribuído a:</strong> {{ oed.atribuido_a.all|join:", "|default:"-" }}</small>
                    </td>
                    <td class="text-center">
                        <a href="{% url view.get_update_url_name pk=oed.pk %}" class="btn btn-sm btn-outline-primary"
                            title="Editar o OED">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center text-muted">Nenhum OED encontrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}